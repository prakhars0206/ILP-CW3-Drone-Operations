name: Drone Dashboard CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Java Backend Unit Tests
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: Build and Test Backend
        # Using -B for batch mode (less log noise)
        run: cd backend && mvn -B test

  # Job 2: Frontend & Integration Tests
  test-frontend-integration:
    runs-on: ubuntu-latest
    needs: test-backend
    steps:
      - uses: actions/checkout@v3
      
      # We need Java available because your tests spawn the Spring Boot backend
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # Install dependencies in the UI folder
      - name: Install Frontend Deps
        run: cd operations-ui && npm ci

      # Build the backend wrapper so it's ready for the launcher
      # We skip tests here because Job 1 already did them
      - name: Build Backend Artifact
        run: cd backend && mvn -B package -DskipTests

      # Run Jest tests (Unit + Integration + Security)
      - name: Run Frontend & Integration Tests
        run: cd operations-ui && npm test
        env:
          CI: true